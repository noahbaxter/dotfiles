#!/bin/zsh
# Compress files for easy sharing (in place)
# Usage: shrink <file1> [file2] ... or shrink *.wav

if [ -z "$1" ]; then
  echo "Usage: shrink <file1> [file2] ... or shrink *.wav"
  exit 1
fi

for input_file in "$@"; do
  if [ ! -f "$input_file" ]; then
    echo "Warning: '$input_file' is not a file, skipping..."
    continue
  fi

  local mime_type=$(file -b --mime-type "$input_file")
  local original_filename=$(basename -- "$input_file")
  local base_name="${original_filename%.*}"
  local extension="${original_filename##*.}"
  local output_file=""

  echo "Processing '$original_filename'..."

  case "$mime_type" in
    # --- Audio Conversion (WAV/MP3 to MP3) ---
    audio/x-wav | audio/wav | audio/mp3 | audio/mpeg)
      output_file="${base_name}_compressed.mp3"
      echo "  → Converting to MP3 (96kbps)..."
      ffmpeg -i "$input_file" -vn -ar 44100 -ac 2 -b:a 96k -c:a libmp3lame "$output_file" -y 2>&1 | tail -1
      if [ -f "$output_file" ]; then
        local original_size=$(du -h "$input_file" | awk '{print $1}')
        local shrunk_size=$(du -h "$output_file" | awk '{print $1}')
        echo "  ✓ $original_size → $shrunk_size"
      else
        echo "  ✗ Failed to convert audio"
      fi
      ;;

    # --- Image Compression ---
    image/jpeg | image/png | image/webp | image/gif)
      output_file="${base_name}_compressed.${extension}"
      if [[ "$mime_type" == "image/gif" ]]; then
        echo "  → Compressing GIF (max 1920px)..."
        convert "$input_file" -resize "1920x1920>" "$output_file"
      else
        echo "  → Compressing image (max 1920px, 85% quality)..."
        convert "$input_file" -resize "1920x1920>" -quality 85 "$output_file"
      fi

      if [ -f "$output_file" ]; then
        local original_size=$(du -h "$input_file" | awk '{print $1}')
        local shrunk_size=$(du -h "$output_file" | awk '{print $1}')
        echo "  ✓ $original_size → $shrunk_size"
      else
        echo "  ✗ Failed to compress image"
      fi
      ;;

    # --- Video Compression (Discord ~10MB target) ---
    video/*)
      output_file="${base_name}_compressed.mp4"
      echo "  → Compressing video for Discord (~10MB target)..."
      ffmpeg -i "$input_file" -vf "scale=min(854\,iw):-1" -preset slow -crf 30 -c:a aac -b:a 64k "$output_file" -y 2>&1 | tail -1
      if [ -f "$output_file" ]; then
        local original_size=$(du -h "$input_file" | awk '{print $1}')
        local shrunk_size=$(du -h "$output_file" | awk '{print $1}')
        echo "  ✓ $original_size → $shrunk_size"
      else
        echo "  ✗ Failed to compress video"
      fi
      ;;

    # --- Generic Compression ---
    *)
      output_file="${original_filename}.zip"
      echo "  → Zipping for compression..."
      zip -r -q "$output_file" "$input_file"
      if [ -f "$output_file" ]; then
        local original_size=$(du -h "$input_file" | awk '{print $1}')
        local shrunk_size=$(du -h "$output_file" | awk '{print $1}')
        echo "  ✓ $original_size → $shrunk_size"
      else
        echo "  ✗ Failed to zip file"
      fi
      ;;
  esac
done
